<h1 class="text-center text-primary mb-5">üì¶ NH·∫¨P S√ÅCH V√ÄO KHO</h1>
<!-- Bi·ªÉu m·∫´u nh·∫≠p s√°ch -->
<form id="book-import-form">
    <table class="table table-bordered text-center align-middle">
        <thead class="table-light">
        <tr>
            <th>STT</th>
            <th>T√™n s√°ch</th>
            <th>Th·ªÉ lo·∫°i</th>
            <th>T√°c gi·∫£</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>X√≥a</th>
        </tr>
        </thead>
        <tbody id="book-rows">
        <!-- Row 1 -->
        <tr>
            <td>1</td>
            <td>
                <select class="form-select select2-enable" name="book_name" style="width: 100%;" required
                        onchange="fillBookDetails(this)">
                    <option value="">Nh·∫≠p t√™n s√°ch</option>
                    {% for book in books %}
                    <option value="{{ book.id }}" data-genre="{{ book.genres|join(', ') }}"
                            data-author="{{ book.authors|join(', ') }}">{{
                        book.name }}
                    </option>
                    {% endfor %}
                </select>
            </td>
            <td><input type="text" class="form-control" name="genre" placeholder="Nh·∫≠p th·ªÉ lo·∫°i" required readonly>
            </td>
            <td><input type="text" class="form-control" name="author" placeholder="Nh·∫≠p t√°c gi·∫£" required readonly>
            </td>
            <td><input type="number" class="form-control" name="quantity" placeholder="0" min="150" required
                       value="150"></td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">
                    X√≥a
                </button>
            </td>
        </tr>
        </tbody>
    </table>
    <div class="d-flex justify-content-end">
        <button type="button" class="btn btn-secondary me-2" onclick="addBookInventoryRow()">‚ûï Th√™m d√≤ng</button>
        <button type="submit" class="btn btn-primary">üì• X√°c nh·∫≠n nh·∫≠p s√°ch v√†o kho</button>
    </div>
</form>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Th√™m d√≤ng m·ªõi v√†o b·∫£ng nh·∫≠p s√°ch v√†o kho
    function addBookInventoryRow() {
        const tableBody = document.getElementById('book-rows');
        const newRowIndex = tableBody.rows.length + 1;

        // HTML cho d√≤ng m·ªõi
        const newRow = `
    <tr>
        <td>${newRowIndex}</td>
        <td>
            <select class="form-select select2-enable" name="book_name" style="width: 100%;" required
                    onchange="fillBookDetails(this)">
                <option value="">Nh·∫≠p t√™n s√°ch</option>
                {% for book in books %}
                <option value="{{ book.id }}" data-genre="{{ book.genres|join(', ') }}"
                        data-author="{{ book.authors|join(', ') }}">{{
                    book.name }}
                </option>
                {% endfor %}
            </select>
        </td>
        <td><input type="text" class="form-control" name="genre" placeholder="Nh·∫≠p th·ªÉ lo·∫°i" required readonly></td>
        <td><input type="text" class="form-control" name="author" placeholder="Nh·∫≠p t√°c gi·∫£" required readonly></td>
        <td><input type="number" class="form-control" name="quantity" placeholder="0" min="150" required value="150"></td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">X√≥a</button>
        </td>
    </tr>`;

        // Th√™m d√≤ng m·ªõi v√†o b·∫£ng
        tableBody.insertAdjacentHTML('beforeend', newRow);

        // Kh·ªüi t·∫°o l·∫°i Select2 cho c√°c ph·∫ßn t·ª≠ m·ªõi
        $('.select2-enable').each(function () {
            if (!$(this).data('select2')) {
                $(this).select2({
                    placeholder: "Nh·∫≠p t√™n s√°ch ƒë·ªÉ t√¨m ki·∫øm",
                    width: 'resolve',
                    allowClear: true
                });
            }
        });
    }

    // X·ª≠ l√Ω Submit Form
    $('#book-import-form').on('submit', function (e) {
        e.preventDefault();

        let booksData = [];

        // Duy·ªát qua t·ª´ng h√†ng trong b·∫£ng
        $('#book-rows tr').each(function () {
            const bookId = $(this).find('select[name="book_name"]').val();
            const quantity = $(this).find('input[name="quantity"]').val();

            booksData.push({
                id: bookId,
                quantity: parseInt(quantity, 10)
            });
        });

        fetch('/store_manager/import_books', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(booksData)
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message)
                if (data.success) {
                    location.reload()
                }
            })
            .catch(error => {
                alert(error)
            })
    });

    // t·ª± ƒë·ªông ƒëi·ªÅn t√°c gi·∫£, th·ªÉ lo·∫°i khi ch·ªçn s√°ch
    function fillBookDetails(selectElement) {
        // L·∫•y th√¥ng tin t·ª´ option ƒë∆∞·ª£c ch·ªçn
        var selectedOption = selectElement.options[selectElement.selectedIndex];

        // L·∫•y genre v√† author t·ª´ thu·ªôc t√≠nh data
        var genres = selectedOption.getAttribute('data-genre');
        var authors = selectedOption.getAttribute('data-author');

        // ƒêi·ªÅn th√¥ng tin v√†o c√°c tr∆∞·ªùng genre v√† author
        var genreField = selectElement.closest('tr').querySelector('input[name="genre"]');
        var authorField = selectElement.closest('tr').querySelector('input[name="author"]');

        genreField.value = genres;
        authorField.value = authors;
    }
</script>