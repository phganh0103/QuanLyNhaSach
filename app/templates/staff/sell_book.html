{%extends '/staff/base.html'%}
{%block content%}
<div class="container my-5">
    <h1 class="text-center">B√°n s√°ch</h1>

    <!-- Search Bar -->
    <div class="row mb-4">
        <!-- Search form -->
        <form class="input-group w-100 my-auto d-none d-sm-flex" id="search_input">
            <div class="row w-100">
                <div class="col-md-8">
                    <input
                            autocomplete="off"
                            type="search"
                            class="form-control rounded"
                            placeholder="T√¨m ki·∫øm s√°ch..."
                            style="min-width: 125px;"
                    />
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary text-blue ms-3 w-100" style="border-radius: 10px;" type="submit">
                        &#128269;
                        T√¨m ki·∫øm
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- QR Code Scanner -->
    <div class="mb-4">
        <h5>üì∏ Qu√©t m√£ s√°ch:</h5>
        <div id="qr-reader"
             style="width: 100%; max-width: 400px; margin: auto; border: 1px dashed gray; padding: 10px;">
            <p class="text-center">üî≤ M√°y qu√©t m√£ QR s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y</p>
        </div>
        <div id="qr-result" class="text-center mt-3 text-success">
            H√£y qu√©t m√£ QR ƒë·ªÉ th√™m s√°ch v√†o gi·ªè h√†ng!
        </div>
    </div>

    <!-- Book List -->
    <h4 class="mb-3">üìñ Danh s√°ch s√°ch:</h4>
    <div class="row" id="book-list">
        {%for item in inventory%}
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{{ item.book.name }}</h5>
                    <p class="card-text">T√°c gi·∫£:
                        {% for author in item.book.authors %}
                        <span>{{ author }}</span>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </p>
                    <p class="card-text">Th·ªÉ lo·∫°i:
                        {% for genre in item.book.genres %}
                        <span>{{ genre }}</span>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </p>
                    <p class="card-text price" data-price={{item.book.price}}></p>
                    <div class="d-flex">
                        <input type="number" id="quantity-{{ item.book.id }}" class="form-control me-2"
                               placeholder="S·ªë l∆∞·ª£ng" min="1" value="1" max={{item.current_quantity}}>
                        <button class="btn btn-primary"
                                onclick="addToCart({{ item.book.id }}, '{{ item.book.name }}', {{ item.book.price }})">Th√™m
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {%endfor%}
        <div class="pagination mt-5 d-flex justify-content-center">
    <nav aria-label="Page navigation example">
        <ul class="pagination">
            {% for i in range(1, pages + 1) %}
            <li class="page-item {% if i == current_page %}active{% endif %}">
                <a class="page-link text-blue fs-5"
                   href="?page={{ i }}{% if query %}&query={{ query }}{% endif %}">
                    {{ i }}
                </a>
            </li>
            {% endfor %}
        </ul>
    </nav>
</div>
    </div>

    <!-- Email Input Section -->
    <div class="card mt-4">
        <div class="card-header text-center bg-secondary text-white">
            ‚úâÔ∏è Th√¥ng tin kh√°ch h√†ng
        </div>
        <div class="card-body">
            <form id="customer-form" onsubmit="handleCustomer(event)">
                <div class="mb-3">
                    <label for="customer-email" class="form-label">Email kh√°ch h√†ng:</label>
                    <input type="email" id="customer-email" class="form-control" placeholder="Nh·∫≠p email c·ªßa b·∫°n"
                           required>
                </div>
                <button type="submit" class="btn btn-primary w-100">X√°c nh·∫≠n</button>
            </form>
            <div id="customer-status" class="mt-3 text-success"></div>
        </div>
    </div>
    <!-- Cart Section -->
    <div class="card mt-4">
        <div class="card-header text-center bg-primary text-white" id="title">
            üõí Gi·ªè H√†ng
        </div>
        <div class="card-body">
            <ul class="list-group" id="cart-items"></ul>
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
            <h5 class="mb-0">T·ªïng ti·ªÅn: <span id="total-price">0</span> VNƒê</h5>
            <button class="btn btn-success" onclick="checkout()">Thanh To√°n</button>
        </div>
    </div>

</div>

<script src="../../static/javascript/format_currency.js"></script>
<script>
    const cart = [];
    let user = null;

    function addToCart(bookId, bookName, bookPrice) {
        const quantityInput = document.getElementById(`quantity-${bookId}`);
        const quantity = parseInt(quantityInput.value);
        if (quantity < 1) return alert("S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0");

        const existing = cart.find(item => item.id === bookId);
        if (existing) {
            existing.quantity += quantity;
        } else {
            cart.push({id: bookId, name: bookName, price: bookPrice, quantity});
        }
        updateCart();
    }

    function updateCart() {
        const cartItems = document.getElementById("cart-items");
        const totalPriceEl = document.getElementById("total-price");
        cartItems.innerHTML = "";
        let totalPrice = 0;

        cart.forEach(item => {
            totalPrice += item.price * item.quantity;
            cartItems.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${item.name} - ${item.quantity} x ${item.price.toLocaleString()} VNƒê
                    <button class="btn btn-danger btn-sm" onclick="removeFromCart(${item.id})">X√≥a</button>
                </li>`;
        });

        totalPriceEl.innerText = totalPrice.toLocaleString();
    }

    function removeFromCart(bookId) {
        const index = cart.findIndex(item => item.id === bookId);
        if (index !== -1) cart.splice(index, 1);
        updateCart();
    }

    function checkout() {
        if (cart.length === 0) return alert("Gi·ªè h√†ng tr·ªëng! H√£y th√™m s√°ch v√†o gi·ªè h√†ng tr∆∞·ªõc khi thanh to√°n.");
        fetch('/staff/sell-book/checkout', {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                'order_details': JSON.stringify(cart),
                'customer_id': user ? user.id : user,
                'seller_id': '{{current_user.id}}'
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(data.message)
                    cart.length = 0;
                    updateCart();
                } else {
                    alert(data.message)
                }
            })
            .catch(error => {
                console.error("L·ªói trong qu√° tr√¨nh fetch:", error);
                alert('C√≥ l·ªói x·∫£y ra khi thanh to√°n.');
            });
    }

    function searchBook() {
        alert("T√¨m ki·∫øm s√°ch ch∆∞a ƒë∆∞·ª£c tri·ªÉn khai.");
    }

    function handleCustomer(event) {
        event.preventDefault();
        const emailInput = document.getElementById("customer-email");
        const email = emailInput.value;

        fetch('/staff/sell-book/find-customer-by-email', {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email})
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    user = data.user
                    alert(`Kh√°ch h√†ng t√¨m th·∫•y: ${data.user.first_name}`);
                    document.getElementById('title').innerText = `Gi·ªè h√†ng c·ªßa ${data.user.first_name}`
                } else {
                    alert("Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng.");
                }
            })
            .catch(error => {
                console.error("L·ªói trong qu√° tr√¨nh fetch:", error);
                alert('C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra email.');
            });

    }

    // QR Code Scanner Integration (Mockup)
    function mockQRCodeResult(bookId, bookName, bookPrice) {
        alert(`M√£ QR qu√©t th√†nh c√¥ng: ${bookName}`);
        addToCart(bookId, bookName, bookPrice);
    }
</script>
<script src="../../static/javascript/search_product.js"></script>
{%endblock%}
